# Emergency Calls - Implementation

This document describes the current emergency calls feature across kiosk, hub, and console after the full lifecycle update.

## High-Level Flow

1. Kiosk detects an emergency (voice keyword detection or SOS button).
2. Kiosk posts the alert to the hub with a kiosk-generated UUID for deduplication.
3. Hub stores the alert and broadcasts SSE events to all console clients.
4. Console operators acknowledge, mark responding, and resolve alerts.
5. Kiosk polls hub status and updates the emergency UI accordingly.

While an emergency is active, the kiosk session timeout is suspended. The timer resumes after dismissal or resolution.

---

## Kiosk

### Detection and Trigger

**File:** `kiosk/app/src/main/java/com/reskiosk/emergency/EmergencyDetector.kt`

Detection runs on both raw and processed transcripts.

- Tier 1 phrases: immediate trigger with a 10-second cancel window.
- Tier 2 keywords: confirmation dialog with a 20-second auto-confirm countdown.

**Manual SOS:**

**File:** `kiosk/app/src/main/java/com/reskiosk/ui/MainKioskScreen.kt`

The SOS button triggers `viewModel.onSosButtonPressed()` and bypasses confirmation.

### State Machine

**File:** `kiosk/app/src/main/java/com/reskiosk/viewmodel/KioskViewModel.kt`

States:
- `EmergencyCancelWindow` (Tier 1 cancel window, 10s)
- `EmergencyConfirmation` (Tier 2 confirmation, 20s auto-confirm)
- `EmergencyPending` (POST /emergency in-flight)
- `EmergencyActive` (alert accepted by hub)
- `EmergencyResponding` (hub status RESPONDING or RESOLVED)
- `EmergencyFailed` (hub unreachable, retry loop)
- `EmergencyCancelled` (false alarm cancel)

Behavior:
- Tier 1 detection starts a 10s cancel window. If not cancelled, it posts to the hub.
- Tier 2 detection shows confirmation. If no response in 20s, it auto-confirms.
- On POST success, kiosk enters `EmergencyActive` and begins polling.
- On POST failure, kiosk enters `EmergencyFailed` and retries every 30s.
- The kiosk polls `/emergency/{id}/status` every 15s.
- `ACKNOWLEDGED` status shows an acknowledged indicator on kiosk.
- When status becomes RESPONDING, UI changes to "Help is on the way."
- When status becomes RESOLVED, kiosk shows resolved state, then auto-dismisses after 30s.
- Dismiss sends `PATCH /emergency/{id}/dismiss` and resumes the inactivity timer.
- Ending a session during an active emergency also sends dismiss to hub.
- SOS cooldown: 60s after dismissal to prevent rapid retriggers.

### Kiosk -> Hub Payload

`POST /emergency`

```
{
  kiosk_id,
  kiosk_location,
  transcript,
  language,
  timestamp,
  tier,
  alert_id_local,
  retry_count
}
```

`alert_id_local` is a UUID generated by the kiosk and used by the hub to deduplicate retries.

---

## Hub

**File:** `hub/api/routes_emergency.py`

### Endpoints

- `POST /emergency`
  - Deduplicates by `alert_id_local`
  - Sets `status = ACTIVE`
  - Returns `alert_id` and payload

- `GET /emergency/stream`
  - SSE stream for console
  - Sends CONNECTED and HEARTBEAT events

- `GET /emergency/active`
  - Returns alerts where `status != RESOLVED`
  - Sorted by `tier ASC, timestamp DESC`

- `GET /emergency/{id}/status`
  - Returns `{ id, status, acknowledged_at, responding_at, dismissed_at, dismissed_by_kiosk, resolved_at }` for kiosk polling

- `PATCH /emergency/{id}/acknowledge`
  - Sets `status = ACKNOWLEDGED`

- `PATCH /emergency/{id}/responding`
  - Sets `status = RESPONDING`

- `PATCH /emergency/{id}/dismiss`
  - Sets `status = DISMISSED` and `dismissed_by_kiosk = 1`

- `POST /emergency/{id}/resolve`
  - Accepts `{ resolution_notes, resolved_by }`
  - Sets `status = RESOLVED` and `resolved = 1`

- `GET /emergency/history`
  - Returns resolved alerts with filters and pagination

### SSE Events

Broadcast payload includes full alert fields plus `type`:

- `EMERGENCY_ALERT`
- `EMERGENCY_ACKNOWLEDGED`
- `EMERGENCY_RESPONDING`
- `EMERGENCY_RESOLVED`
- `EMERGENCY_DISMISSED`

### Database Fields

**Table:** `emergency_alerts`

Key fields (additive):
- `status` (ACTIVE, ACKNOWLEDGED, RESPONDING, RESOLVED, DISMISSED)
- `tier`
- `alert_id_local`
- `acknowledged_at`, `responding_at`, `dismissed_at`, `resolved_at`
- `dismissed_by_kiosk`
- `resolution_notes`, `resolved_by`
- `retry_count`

`resolved` and `resolved_at` are retained for backward compatibility, but `status` is authoritative.

---

## Console

**File:** `console/src/pages/EmergencyCalls.jsx`

Behavior:
- Loads active alerts from `GET /emergency/active`.
- Receives live updates via SSE.
- Shows tier badges (CRITICAL/CONFIRMED) and status badges.
- Action flow: Acknowledge -> Responding -> Resolve.
- Plays `emergencycallalert.mp3` once per newly received `EMERGENCY_ALERT` event (respects mute).
- History tab loads `GET /emergency/history` with filters.
- CSV export of the current history view.

---

## Session Timeout Behavior

Emergency states call `cancelInactivityTimer()` to suspend timeout. The timer resumes once the emergency is dismissed or resolved.
