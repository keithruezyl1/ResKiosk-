# Schema Migration Implementation Plan

## Goal Description
The database schema has been merged from an old version and a new version. The goal is to update the entire codebase (Hub backend, Admin Console frontend, Kiosk Android app) to correctly interface with the newly merged schema. This involves fixing ORM models to match the final schema exactly, changing Pydantic models to serve the updated column names, and adjusting the frontend UI appropriately while preserving all functionalities.

## Proposed Changes

### Database Models (Hub)
#### [MODIFY] [schema.py](file:///c:/Users/Keith/Documents/ResKiosk/hub/db/schema.py)(file:///c:/Users/Keith/Documents/ResKiosk/hub/db/schema.py)
- **[KBArticle](file:///c:/Users/Keith/Documents/ResKiosk/hub/db/schema.py#82-106)**: Remove the `@property title` and `@property body` aliases.
- **[QueryLog](file:///c:/Users/Keith/Documents/ResKiosk/hub/db/schema.py#7-30)**: Fix the model to exactly match the 18 columns in the merged schema. Remove rogue columns like `intent`, `intent_confidence`, `selected_clarification`, and `rewrite_applied`. Add `rewrite_attempted` (Boolean), `rewritten_query` (Text), and `source_id` (Integer).
- **[HubIdentity](file:///c:/Users/Keith/Documents/ResKiosk/hub/db/schema.py#65-80)**: Fix the corrupted model which accidentally contains a duplicate [QueryLog](file:///c:/Users/Keith/Documents/ResKiosk/hub/db/schema.py#7-30) definition. Define it correctly with `id`, `hub_id`, `hub_name`, `created_at`.
- **`KBMeta`**: Add missing table (`id`, [kb_version](file:///c:/Users/Keith/Documents/ResKiosk/hub/api/routes_kb.py#10-16), `updated_at`).
- **`KioskRegistry`**: Add missing table (`kiosk_id`, `kiosk_name`, `ip_address`, `hub_id`, `first_seen`, `last_seen`).
- **`StructuredConfig`**: Add missing table (`key`, `value`, `updated_at`).

### Backend Core & API (Hub)
#### [MODIFY] [api_models.py](file:///c:/Users/Keith/Documents/ResKiosk/hub/models/api_models.py)(file:///c:/Users/Keith/Documents/ResKiosk/hub/models/api_models.py)
- Update [ArticleBase](file:///c:/Users/Keith/Documents/ResKiosk/hub/models/api_models.py#13-31), [ArticleCreate](file:///c:/Users/Keith/Documents/ResKiosk/hub/models/api_models.py#33-35), [ArticleUpdate](file:///c:/Users/Keith/Documents/ResKiosk/hub/models/api_models.py#37-43), [ArticleResponse](file:///c:/Users/Keith/Documents/ResKiosk/hub/models/api_models.py#45-85) to use `question: str` and `answer: str` instead of `title: str` and `body: str`.
- Remove the `@field_validator` hooks for [title](file:///c:/Users/Keith/Documents/ResKiosk/hub/db/schema.py#99-102) and [body](file:///c:/Users/Keith/Documents/ResKiosk/hub/db/schema.py#103-106) in [ArticleResponse](file:///c:/Users/Keith/Documents/ResKiosk/hub/models/api_models.py#45-85).

#### [MODIFY] [routes_admin.py](file:///c:/Users/Keith/Documents/ResKiosk/hub/api/routes_admin.py)(file:///c:/Users/Keith/Documents/ResKiosk/hub/api/routes_admin.py)
- Update [create_article](file:///c:/Users/Keith/Documents/ResKiosk/hub/api/routes_admin.py#40-63) to read from `article.question` and `article.answer`.
- Update [update_article](file:///c:/Users/Keith/Documents/ResKiosk/hub/api/routes_admin.py#65-101) to check `update.question` and `update.answer`.
- Update [import_articles](file:///c:/Users/Keith/Documents/ResKiosk/hub/api/routes_admin.py#190-254) to read JSON fields `"question"` and `"answer"`.

#### [MODIFY] [bulk_kb_import.py](file:///c:/Users/Keith/Documents/ResKiosk/hub/bulk_kb_import.py)(file:///c:/Users/Keith/Documents/ResKiosk/hub/bulk_kb_import.py)
- Update JSON template structure references from 'title'/'body' to 'question'/'answer'.

#### [MODIFY] [kb_import_template.json](file:///c:/Users/Keith/Documents/ResKiosk/hub/kb_import_template.json)(file:///c:/Users/Keith/Documents/ResKiosk/hub/kb_import_template.json)
- Replace all keys `"title"` and `"body"` with `"question"` and `"answer"`.

### Admin Console (Frontend)
#### [MODIFY] [FAQManager.jsx](file:///c:/Users/Keith/Documents/ResKiosk/console/src/pages/FAQManager.jsx)(file:///c:/Users/Keith/Documents/ResKiosk/console/src/pages/FAQManager.jsx)
- Update the component's state hook variables [title](file:///c:/Users/Keith/Documents/ResKiosk/hub/db/schema.py#99-102) -> `question` and [body](file:///c:/Users/Keith/Documents/ResKiosk/hub/db/schema.py#103-106) -> `answer`.
- Update input values and form handlers.
- Adjust the JSON upload verification logic to require `a.question` and `a.answer`.
- Update the expected JSON format string snippet in the modal to show `question` and `answer`.

#### [MODIFY] [KBViewer.jsx](file:///c:/Users/Keith/Documents/ResKiosk/console/src/pages/KBViewer.jsx)(file:///c:/Users/Keith/Documents/ResKiosk/console/src/pages/KBViewer.jsx)
- Update table column mappings (`{a.title}` -> `{a.question}`).
- Update search and filter conditions to check `a.question`.
- Update the new article form state from [title](file:///c:/Users/Keith/Documents/ResKiosk/hub/db/schema.py#99-102)/[body](file:///c:/Users/Keith/Documents/ResKiosk/hub/db/schema.py#103-106) to `question`/`answer` and matching `onChange` handlers.
- Update the JSON upload validation logic to require `a.question` and `a.answer`.
- Update the expected JSON format tooltip.

### Kiosk (Android)
No codebase changes directly reference `KBArticle.title` or `KBArticle.body`. The app relies on `/query` endpoint resolving answers which maps to `answer_text_en`. No schema-specific structural updates are needed for the Android UI.

## Verification Plan

### Automated Tests
- N/A - The repository currently lacks automated unit tests for [schema.py](file:///c:/Users/Keith/Documents/ResKiosk/hub/db/schema.py) and the KB ingestion flow.

### Manual Verification
1. Run [check.py](file:///c:/Users/Keith/Documents/ResKiosk/check.py) to ensure python files can run without syntax errors.
2. Ensure the hub backend application starts successfully via `python -m hub.main` or [launcher.py](file:///c:/Users/Keith/Documents/ResKiosk/hub/launcher.py). 
3. Run `npm run build` in `console` directory to verify standard JSX compilation.
4. Manually hit `GET /kb/snapshot` through cURL/python requests and verify that it correctly returns `question` and `answer` fields instead of [title](file:///c:/Users/Keith/Documents/ResKiosk/hub/db/schema.py#99-102) and [body](file:///c:/Users/Keith/Documents/ResKiosk/hub/db/schema.py#103-106).
